## 通过路由器连接的两个网络

#### 端系统（end system）

#### 中间系统 

#### 应用层和运输层使用端到端协议

#### 网络层提供逐跳协议

#### 网络IP提供的是一种不可靠的服务，他只是尽可能吧分组从源节点送到目的节点，但不提供可靠性保障

#### TCP在不可靠的IP层提供一个可靠的运输层

#### 互联网的目的之一就是在应用程序中隐藏所有的物理细节

## TCP/IP协议族中不同层次的协议

TCP（全双工只需要一个端口号就行）使用不可靠的IP服务，并提供一种可靠的运输层服务

UDP为应用程序发送和接受数据报，和TCP不同，UDP是不可靠的

TCP丢包会重传，但是UDP丢包不会重传（语音）

IP是网络层上主要协议，同时被TCP和UDP使用

ICMP是IP协议的**附属协议**（当我们IP包丢失，通过ICMP发送给IP包发送源，告诉这个源什么原因这个IP包被丢弃了） PING是个应用程序，这个应用程序调用了ICMP

链路层主要有两个协议（ARP协议   RARP协议）

ARP完成IP地址（32位）解析成mac地址

## 封装(发送方)

![1603193821746](C:\Users\飞龙\AppData\Local\Temp\1603193821746.png)



以太网数据帧物理特性是长度在46~1500字节之间 （不够要补齐46，大于1500要分片）

以太网的帧首部有个16Bit的帧类型域

IP在首部中存入一个长度为8bit的数值，称作协议域（icmp,igmp,tcp,udp,esp,gre）

TCP和UDP都用一个16bit的端口号来表示不同的应用程序（ftp telnet http）

## 分用（接收方）



![1603194624355](C:\Users\飞龙\AppData\Local\Temp\1603194624355.png)

##  端口号

服务器一般都是通过知名端口号来识别（ftp 21 , telent 23）

客户端口号又称**临时端口号**（即**存在时间很短暂**）

大多数TCP/IP实现给临时端口号分配1024 ~ 5000之间的端口号 （源端口号是随机的，目的端口号是固定的）

大于5000的端口号是为其他服务器预留的（Internet上不常用的服务）

## 链路层

#### 以太网

标准速率10Mb/s,地址为48bit

#### IEEE 802封装

802.3针对整个CSMA/CD网络

### 封装格式

区分帧是以太网的帧还是8023帧关键在于看一个位表示长度还是类型

![1603197828736](C:\Users\飞龙\AppData\Local\Temp\1603197828736.png)

以太网和802.3两种帧都采用48bit(6字节)的目的地址和源地址

ARP和RARP协议对32bit的IP地址和48bit的硬件地址进行映射

802.3定义有效长度值与以太网的有效类型无一相同，这样，就可以对两种帧格式进行区分

802.3规定数据不分至少为38字节，对于以太网，要求至少要有46字节，为保证这点，必须在不足空间插入填充（pad）字节

0800 IP头部

0806 ARP协议

### 环回接口

传给环回地址（127.0.0.1）的任何数据均作为IP输入  （ping 一下）

传给广播地址或者多播地址的数据报复制一份传给环回接口，然后送到以太网上。

任何传给该主机IP地址的数据均送到环回接口

![1603199079484](C:\Users\飞龙\AppData\Local\Temp\1603199079484.png)

### MTU（最大传输单元）和路径MTU

以太网和802.3对数据帧长度都有一个限制，其最大值分别是1500和1492字节

如果IP层有一个数据报要传，而且数据报长度比链路层MTU还要大，IP层就要进行**分片**，将数据报分成若干片，使每一片长度都小于MTU。

点到点链路层和MTU并非指的是网络媒体和物理特性，这是个逻辑显示，目的是为交互使用提供足够快的响应时间。

两台通信主机路径中的最小MTU，被称作路径MTU

路径MTU在两个方向上不一定是一致的

## IP协议

IP协议是TCP/IP协议族中最核心的协议。所有的TCP、UDP、ICMP以及IGMP数据都以IP数据报格式传输

IP提供不可靠、无连接的数据报传送服务

不可靠的意思是它不能保证数据报能成功到达目的地。IP仅提供最好的传输服务。如果发生某种错误时，如某个路由器暂时用完了缓冲区，IP有一个简单的错误处理算法：丢弃该数据报，然后通过ICMP发送ICMP消息给信源端。任何要求的可靠性必须由上层提供（如TCP）

无连接是IP并不维护后续数据报的状态信息，每个数据报处理是相互独立的，IP数据报可以不按发送顺序接收。如果信源向相同的信宿放两个连续的数据报（A B），因为每个数据报都是独立地进行路由选择，可能选择不同路线，因此B可能在A到达之前到达。

ifconfig netstat

linux下如歌更改ip地址

ifconfig eth0 1.2.3.4 netmask 255.255.255.0

nestat -an 查看会话信息

netstat -r 查看路由表

## IP头部

首部最小20个字节，最大60个字节。最小时就是只有固定部分（每个单位32bit，也就是4个字节，共5行，就是20个字节），一个单位指的是一行。 

![1603250068160](C:\Users\飞龙\AppData\Local\Temp\1603250068160.png)

生存时间（TTL）: 每过一个路由器这个TTL就减一，因为可能会出现环路，如果不做TTL就会永远环路下去











