## 通过路由器连接的两个网络

#### 端系统（end system）

#### 中间系统 

#### 应用层和运输层使用端到端协议

#### 网络层提供逐跳协议

#### 网络IP提供的是一种不可靠的服务，他只是尽可能吧分组从源节点送到目的节点，但不提供可靠性保障

#### TCP在不可靠的IP层提供一个可靠的运输层

#### 互联网的目的之一就是在应用程序中隐藏所有的物理细节

## TCP/IP协议族中不同层次的协议

TCP（全双工只需要一个端口号就行）使用不可靠的IP服务，并提供一种可靠的运输层服务

UDP为应用程序发送和接受数据报，和TCP不同，UDP是不可靠的

TCP丢包会重传，但是UDP丢包不会重传（语音）

IP是网络层上主要协议，同时被TCP和UDP使用

ICMP是IP协议的**附属协议**（当我们IP包丢失，通过ICMP发送给IP包发送源，告诉这个源什么原因这个IP包被丢弃了） PING是个应用程序，这个应用程序调用了ICMP

链路层主要有两个协议（ARP协议   RARP协议）

ARP完成IP地址（32位）解析成mac地址

## 封装(发送方)

![1603193821746](C:\Users\飞龙\AppData\Local\Temp\1603193821746.png)



以太网数据帧物理特性是长度在46~1500字节之间 （不够要补齐46，大于1500要分片）

以太网的帧首部有个16Bit的帧类型域

IP在首部中存入一个长度为8bit的数值，称作协议域（icmp,igmp,tcp,udp,esp,gre）

TCP和UDP都用一个16bit的端口号来表示不同的应用程序（ftp telnet http）

## 分用（接收方）



![1603194624355](C:\Users\飞龙\AppData\Local\Temp\1603194624355.png)

##  端口号

服务器一般都是通过知名端口号来识别（ftp 21 , telent 23）

客户端口号又称**临时端口号**（即**存在时间很短暂**）

大多数TCP/IP实现给临时端口号分配1024 ~ 5000之间的端口号 （源端口号是随机的，目的端口号是固定的）

大于5000的端口号是为其他服务器预留的（Internet上不常用的服务）

## 链路层

#### 以太网

标准速率10Mb/s,地址为48bit

#### IEEE 802封装

802.3针对整个CSMA/CD网络

### 封装格式

区分帧是以太网的帧还是8023帧关键在于看一个位表示长度还是类型

![1603197828736](C:\Users\飞龙\AppData\Local\Temp\1603197828736.png)

以太网和802.3两种帧都采用48bit(6字节)的目的地址和源地址

ARP和RARP协议对32bit的IP地址和48bit的硬件地址进行映射

802.3定义有效长度值与以太网的有效类型无一相同，这样，就可以对两种帧格式进行区分

802.3规定数据不分至少为38字节，对于以太网，要求至少要有46字节，为保证这点，必须在不足空间插入填充（pad）字节

0800 IP头部

0806 ARP协议

### 环回接口

传给环回地址（127.0.0.1）的任何数据均作为IP输入  （ping 一下）

传给广播地址或者多播地址的数据报复制一份传给环回接口，然后送到以太网上。

任何传给该主机IP地址的数据均送到环回接口

![1603199079484](C:\Users\飞龙\AppData\Local\Temp\1603199079484.png)

### MTU（最大传输单元）和路径MTU

以太网和802.3对数据帧长度都有一个限制，其最大值分别是1500和1492字节

如果IP层有一个数据报要传，而且数据报长度比链路层MTU还要大，IP层就要进行**分片**，将数据报分成若干片，使每一片长度都小于MTU。

点到点链路层和MTU并非指的是网络媒体和物理特性，这是个逻辑显示，目的是为交互使用提供足够快的响应时间。

两台通信主机路径中的最小MTU，被称作路径MTU

路径MTU在两个方向上不一定是一致的

## IP协议

IP协议是TCP/IP协议族中最核心的协议。所有的TCP、UDP、ICMP以及IGMP数据都以IP数据报格式传输

IP提供不可靠、无连接的数据报传送服务

不可靠的意思是它不能保证数据报能成功到达目的地。IP仅提供最好的传输服务。如果发生某种错误时，如某个路由器暂时用完了缓冲区，IP有一个简单的错误处理算法：丢弃该数据报，然后通过ICMP发送ICMP消息给信源端。任何要求的可靠性必须由上层提供（如TCP）

无连接是IP并不维护后续数据报的状态信息，每个数据报处理是相互独立的，IP数据报可以不按发送顺序接收。如果信源向相同的信宿放两个连续的数据报（A B），因为每个数据报都是独立地进行路由选择，可能选择不同路线，因此B可能在A到达之前到达。

ifconfig netstat

linux下如歌更改ip地址

ifconfig eth0 1.2.3.4 netmask 255.255.255.0

nestat -an 查看会话信息

netstat -r 查看路由表

## IP头部

首部最小20个字节，最大60个字节。最小时就是只有固定部分（每个单位32bit，也就是4个字节，共5行，就是20个字节），一个单位指的是一行。 

![1603250068160](C:\Users\飞龙\AppData\Local\Temp\1603250068160.png)

区分服务（TOS）:包括3 bit的优先权字段（取值可以从000-111所有值），4 bit的TOS子字段和1 bit未用位但必须置0,4 bit的TOS分别代表：最小时延、最大吞吐量、最高可靠性和最小费用。4 bit中只能置其中1 bit。如果所有4 bit均为0，那么就意味着是一般服务。Telnet、Rlogin这两个交互应用要求最小的传输时延，FTP文件传输要求最大吞吐量，最高可靠性是指网络管理（SNMP）和路由选择协议。用户网络新闻要求最小费用

片偏移：如果数据报大于一定长度会分片，会有偏移量的计算，如果不大于偏移量为0

生存时间（TTL）: 每过一个路由器这个TTL就减一，因为可能会出现环路，如果不做TTL就会永远环路下去

8位协议号：协议类型 （如 TCP为6  ,17UDP , 1 ICMP ）

首部检验和：收到的包和发送的包进行检验，校验数据的完整性。

**可选字段** 

最后一个字段是任选项，是数据报中一个可变长的可选信息。

定义如下：

记录路径（让每个路由器都记下它的IP地址） 时间戳 （让每个路由器记下它IP地址和时间）宽松源站选路（为数据报指定一系列必须经过的IP地址） 严格源站选路

#### 特殊情况的IP地址

![](C:\Users\飞龙\AppData\Roaming\Typora\typora-user-images\image-20201021161113922.png)

## ARP协议

当一台主机把以太网帧发送到位于同一局域网上的另一台主机时，是根据48bit的以太网地址来确定目的接口的。设备驱动程序不检查IP数据报中的目的IP地址

地址解析为这两种个不同地址形式提供映射：32bit的IP地址和数据链路层使用的任何类型的地址

ARP为IP地址到对应的硬件地址之间提供动态映射。这个过程是自动完成的。（基于IP找mac）

RARP是被那些没有磁盘驱动器的系统使用（一般是无盘工作站或X终端）需要系统管理员手动设置。(基于mac找IP)

![image-20201021164212983](C:\Users\飞龙\AppData\Roaming\Typora\typora-user-images\image-20201021164212983.png)

ARP地址解析协议是如何工作的？

涉及一个常考面试知识点，在浏览器中输入www.baidu.com会出现什么情况？

首先我们是想让包含该浏览器（应用程序）的主机和百度的服务器进行交互，从百度服务器上获取数据，首先我们主机会对www.baidu.com进行一个域名解析（通过解析器，DNS协议等），将这个域名进行解析成ip地址。应用层让TCP建立连接，TCP将IP地址和请求封装成一个IP包进行发送，发送时会出现两种情况：目的主机和发送主机是直连网络还是非直连网络，如果是直连网络，主机就会直接发送ARP请求获取目的主机的mac地址，不是直连网络（比如中间过了一台路由器），这时候源主机就会查路由查询路由直到目的IP的mac地址。ARP获取到mac地址后会发送一个ARP的广播（二层广播包，所有主机都能收到）出来，所有主机都可以收到，主机就会判断自己IP是不是广播出来的IP，如果有主机IP是这个广播IP，该主机就会回应（二层单波包有明确的源mac,也有明确的目的mac，回应只有发起者才能收到），这时候主机和服务器有了IP地址和映射，主机应用程序就能和百度服务器进行交互。





















